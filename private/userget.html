<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Dashboard</title>
  <style>
    body { font-family: Arial; padding:20px; background:#f4f6f8; }
    table { width:100%; border-collapse:collapse; background:#fff; }
    th,td { padding:10px; border:1px solid #ddd; text-align:center; }
    th { background:#007bff; color:#fff; }
    img { width:60px; height:60px; object-fit:cover; border-radius:50%; }
  </style>
</head> 
<body>

<input
  type="text"
  id="searchInput"
  placeholder="Search users"
  onkeyup="debouncedSearch()"
/>


<div style="text-align:center; margin-top:15px;">
  <button onclick="prevPage()">Prev</button>
  <span id="pageInfo"></span>
  <button onclick="nextPage()">Next</button>
</div>

<h2>Users List</h2>
<button onclick="logout()">Logout</button>
<table>
  <thead>
    <tr>
      <th>ID</th><th>Name</th><th>Email</th><th>Mobile</th><th>Image</th><th>Action</th>
    </tr>
  </thead>
  <tbody id="usersTable">
    <tr><td colspan="6">Loading...</td></tr>
  </tbody>
</table>

<script>
  let currentPage = 1;
   const limit = 5;


   async function apiFetch(url, options = {}) {
  options.credentials = "include";

  let res = await fetch(url, options);

  if (res.status === 401) {
    // try refresh
    const refreshRes = await fetch("/api/auth/refresh-token", {
      method: "POST",
      credentials: "include"
    });

    if (!refreshRes.ok) {
      throw new Error("Session expired");
    }

    // retry original request
    res = await fetch(url, options);
  }

  return res;
}
   
async function loadUsers() {
   const search = document.getElementById("searchInput").value;

  try {
    

 const res = await apiFetch(
      `/api/auth/users?page=${currentPage}&limit=${limit}&search=${search}`
    );
    // if (!res.ok) throw new Error("Unauthorized");

    const data = await res.json();
    const users = data.data;
     const pageInfo = data.pagination;
    const table = document.getElementById("usersTable");
    table.innerHTML = '';

    if (users.length === 0) {
      table.innerHTML = '<tr><td colspan="6">No users found</td></tr>';
      return;
    }

    users.forEach(user => {
      const row = `
        <tr>
          <td>${user.id}</td>
          <td>${user.name}</td>
          <td>${user.email}</td>
          <td>${user.mobile}</td>
          <td>${user.image ? `<img src="/uploads/${user.image}" />` : 'No Image'}</td>
          <td>
            <a href="detailspdf.html?id=${user.id}">
           <button>View Details</button>
              </a>
            <a href="updateuser.html?id=${user.id}"><button>Edit</button></a>
            <button onclick="deleteUser(${user.id})">Delete</button>
          </td>
        </tr>
      `;
      table.innerHTML += row;
    });

       document.getElementById("pageInfo").innerText =
      `Page ${pageInfo.page} of ${pageInfo.totalPages}`;

  } catch(err) {
    console.error(err);
    alert("Please login again");
    window.location.href = "login.html";
  }
}

function logout() {
  fetch("/api/auth/logout", { method:"POST", credentials:"include" })
    .then(() => window.location.href = "login.html");
}



loadUsers();
function nextPage() {
  currentPage++;
  loadUsers();
}

function prevPage() {
  if (currentPage > 1) {
    currentPage--;
    loadUsers();
  }
}

let debounceTimer;

function debouncedSearch() {
  clearTimeout(debounceTimer);

  debounceTimer = setTimeout(() => {
    currentPage = 1;
    loadUsers(); // your API call
  }, 400); // 400ms delay
}


</script>

</body>
</html>
